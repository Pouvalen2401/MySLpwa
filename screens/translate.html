<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#4F46E5" />
  <title>SignSpeak - Translate</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Main Styles -->
  <link rel="stylesheet" href="../css/main.css">
</head>

<body>

<!-- Header -->
<header class="header-custom">
  <div class="container-custom">
    <div class="header-content">
      <a href="home.html" class="logo">ğŸ¤Ÿ SignSpeak</a>

      <nav class="nav-custom">
        <a href="home.html" class="nav-link-custom">Home</a>
        <a href="translate.html" class="nav-link-custom active">Translate</a>
        <a href="settings.html" class="nav-link-custom">Settings</a>
      </nav>
    </div>
  </div>
</header>

<!-- Main Content -->
<main class="container-custom" style="padding: 24px 20px;">

  <!-- Mode Toggle -->
  <div class="card-custom mb-3">
    <div class="flex justify-between align-center">
      <h2 id="modeTitle">Sign to Text</h2>
      <button id="switchModeBtn" class="btn-primary-custom">Switch Mode</button>
    </div>
  </div>

  <!-- ================= SIGN TO TEXT ================= -->
  <div id="signToTextMode">

    <div class="row g-3">

      <!-- Video Feed -->
      <div class="col-lg-8">
        <div class="card-custom">
          <div class="video-container" style="position: relative;">
            <video
              id="videoElement"
              autoplay
              muted
              playsinline
              style="width: 100%; border-radius: 12px;">
            </video>
          </div>

          <div class="mt-3 flex justify-between align-center">
            <button id="startCameraBtn" class="btn-primary-custom">Start Camera</button>
          </div>
        </div>
      </div>

      <!-- Output Panel -->
      <div class="col-lg-4">
        <div class="card-custom">
          <h3 class="mb-2">Detected Signs</h3>

          <!-- Mood Indicator -->
          <div class="mb-3 p-2" style="background: var(--bg-light); border-radius: 8px;">
            <div class="text-muted mb-1" style="font-size: 12px;">Current Mood</div>
            <div class="flex align-center gap-2">
              <span id="moodEmoji" style="font-size: 24px;">ğŸ˜</span>
              <span id="moodText">Neutral</span>
            </div>
          </div>

          <!-- Translation Output -->
          <textarea
            id="translationOutput"
            class="form-control-custom"
            rows="8"
            readonly
            placeholder="Your signs will appear here...">
          </textarea>

          <!-- Actions -->
          <div class="flex gap-2 mt-3">
            <button id="clearBtn" class="btn-outline-custom flex-1">Clear</button>
            <button id="speakBtn" class="btn-primary-custom flex-1">ğŸ”Š Speak</button>
            <button id="copyBtn" class="btn-outline-custom">ğŸ“‹</button>
          </div>

        </div>
      </div>

    </div>
  </div>

  <!-- ================= TEXT TO SIGN ================= -->
  <div id="textToSignMode" style="display:none;">

    <div class="row g-3">

      <div class="col-lg-4">
        <div class="card-custom">
          <h3 class="mb-3">Enter Text</h3>

          <textarea
            id="textInput"
            class="form-control-custom"
            rows="6"
            placeholder="Type text to see sign language...">
          </textarea>

          <button id="translateTextBtn" class="btn-primary-custom w-100 mt-3">
            Translate
          </button>
        </div>
      </div>

      <div class="col-lg-8">
        <div class="card-custom text-center">
          <h3 class="mb-3">Avatar Demonstration</h3>

          <div id="avatarDisplay"
               style="min-height: 400px; display:flex; align-items:center; justify-content:center;">
          </div>

          <div class="mt-3 flex gap-2 justify-center">
            <button id="playAnimationBtn" class="btn-primary-custom">â–¶ï¸ Play</button>
            <button id="pauseAnimationBtn" class="btn-outline-custom">â¸ï¸ Pause</button>
            <button id="repeatAnimationBtn" class="btn-outline-custom">ğŸ”„ Repeat</button>
          </div>
        </div>
      </div>

    </div>
  </div>

</main>

<!-- ================= SCRIPTS ================= -->

<script src="../js/utils.js"></script>
<script src="../js/storage-manager.js"></script>
<script src="../js/settings-manager.js"></script>

<!-- Face API -->
<script defer src="../js/face-api.min.js"></script>

<!-- Camera Handler -->
<script defer src="../js/camera-handler.js"></script>

<script src="../js/avatar-manager.js"></script>
<script src="../js/avatar-animator.js"></script>

<script>
  let currentUserId = null;
  let currentMode = 'sign-to-text';
  let cameraHandler = null;

  async function init() {
    currentUserId = Utils.getLocalStorage('currentUserId');
    if (!currentUserId) {
      window.location.href = '../index.html';
      return;
    }

    await SettingsManager.init(currentUserId);
    showMode(currentMode);
  }

  function showMode(mode) {
    currentMode = mode;

    document.getElementById('signToTextMode').style.display =
      mode === 'sign-to-text' ? 'block' : 'none';

    document.getElementById('textToSignMode').style.display =
      mode === 'text-to-sign' ? 'block' : 'none';

    document.getElementById('modeTitle').textContent =
      mode === 'sign-to-text' ? 'Sign to Text' : 'Text to Sign';

    if (mode === 'text-to-sign') {
      AvatarManager.renderToElement(document.getElementById('avatarDisplay'));
      AvatarAnimator.init('avatarDisplay');
    }
  }

  document.getElementById('switchModeBtn').addEventListener('click', () => {
    showMode(currentMode === 'sign-to-text' ? 'text-to-sign' : 'sign-to-text');
  });

  document.getElementById('startCameraBtn').addEventListener('click', async () => {
    try {
      if (!cameraHandler) {
        const video = document.getElementById('videoElement');
        cameraHandler = new CameraHandler(video);

        cameraHandler.onMoodDetected = (mood) => {
          const moodMap = {
            happy: ['ğŸ˜Š', 'Happy'],
            sad: ['ğŸ˜¢', 'Sad'],
            angry: ['ğŸ˜ ', 'Angry'],
            surprised: ['ğŸ˜²', 'Surprised'],
            neutral: ['ğŸ˜', 'Neutral']
          };

          const m = moodMap[mood] || moodMap.neutral;
          document.getElementById('moodEmoji').textContent = m[0];
          document.getElementById('moodText').textContent = m[1];
        };
      }

      await cameraHandler.init();
      Utils.showToast('Camera started', 'success');

    } catch (err) {
      console.error(err);
      Utils.showToast('Failed to start camera', 'error');
    }
  });

  document.getElementById('clearBtn').onclick = () => {
    document.getElementById('translationOutput').value = '';
  };

  document.getElementById('speakBtn').onclick = () => {
    const text = document.getElementById('translationOutput').value;
    if (text) TranslationEngine.speakText(text);
  };

  document.getElementById('copyBtn').onclick = () => {
    const text = document.getElementById('translationOutput').value;
    if (text) Utils.copyToClipboard(text);
  };

  window.addEventListener('DOMContentLoaded', init);

  window.addEventListener('beforeunload', () => {
    if (cameraHandler) cameraHandler.cleanup();
  });
</script>

</body>
</html>
