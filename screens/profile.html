<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#4F46E5">
  <title>SignSpeak - Profile</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../css/main.css">
</head>
<body>
  <!-- Header -->
  <header class="header-custom">
    <div class="container-custom">
      <div class="header-content">
        <a href="home.html" class="logo">ü§ü SignSpeak</a>
        
        <nav class="nav-custom">
          <a href="home.html" class="nav-link-custom">Home</a>
          <a href="translate.html" class="nav-link-custom">Translate</a>
          <a href="profile.html" class="nav-link-custom active">Profile</a>
          <a href="settings.html" class="nav-link-custom">Settings</a>
        </nav>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container-custom" style="padding: 24px 20px; max-width: 800px;">
    <h1 class="mb-4">User Profile</h1>

    <!-- Profile Card -->
    <section class="card-custom mb-4">
      <div class="flex gap-3 align-center mb-3">
        <div id="profileAvatar" style="width: 100px; height: 130px;">
          <!-- Avatar preview -->
        </div>
        <div class="flex-1">
          <h2 id="profileName">User</h2>
          <p class="text-muted mb-2" id="profileEmail"></p>
          <p class="text-muted" style="font-size: 14px;">Member since <span id="memberSince"></span></p>
        </div>
      </div>

      <button onclick="window.location.href='avatar-customization.html'" class="btn-outline-custom w-100">
        Edit Avatar
      </button>
    </section>

    <!-- Statistics -->
    <section class="card-custom mb-4">
      <h2 class="mb-3">Your Statistics</h2>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalTranslations">0</div>
          <div class="stat-label">Total Translations</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-value" id="signsLearned">0</div>
          <div class="stat-label">Signs Learned</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-value" id="daysActive">0</div>
          <div class="stat-label">Days Active</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-value" id="avgPerDay">0</div>
          <div class="stat-label">Avg/Day</div>
        </div>
      </div>
    </section>

    <!-- Activity Chart -->
    <section class="card-custom mb-4">
      <h2 class="mb-3">Translation Activity</h2>
      <div id="activityChart" style="min-height: 200px; display: flex; align-items: center; justify-content: center; color: var(--text-muted-light);">
        Activity chart visualization would go here
      </div>
    </section>

    <!-- Recent Achievements -->
    <section class="card-custom mb-4">
      <h2 class="mb-3">Achievements</h2>
      
      <div class="achievement-grid">
        <div class="achievement-card" id="achievement1">
          <div class="achievement-icon">üéØ</div>
          <div class="achievement-name">First Steps</div>
          <div class="achievement-desc">Complete your first translation</div>
        </div>
        
        <div class="achievement-card locked" id="achievement2">
          <div class="achievement-icon">üî•</div>
          <div class="achievement-name">On Fire</div>
          <div class="achievement-desc">10 translations in one day</div>
        </div>
        
        <div class="achievement-card locked" id="achievement3">
          <div class="achievement-icon">‚≠ê</div>
          <div class="achievement-name">Star Signer</div>
          <div class="achievement-desc">Learn 50 different signs</div>
        </div>
        
        <div class="achievement-card locked" id="achievement4">
          <div class="achievement-icon">üèÜ</div>
          <div class="achievement-name">Master</div>
          <div class="achievement-desc">100 total translations</div>
        </div>
      </div>
    </section>

    <!-- Account Actions -->
    <section class="card-custom">
      <h2 class="mb-3">Account</h2>
      
      <div class="flex flex-column gap-2">
        <button id="editNameBtn" class="btn-outline-custom">Edit Name</button>
        <button onclick="window.location.href='settings.html'" class="btn-outline-custom">Settings</button>
        <button id="deleteAccountBtn" class="btn-outline-custom" style="color: var(--danger-color); border-color: var(--danger-color);">
          Delete Account
        </button>
      </div>
    </section>
  </main>

  <!-- Edit Name Modal -->
  <div id="editNameModal" class="modal" style="display: none;">
    <div class="modal-content card-custom" style="max-width: 400px; margin: 100px auto;">
      <h2 class="mb-3">Edit Name</h2>
      
      <input type="text" id="newNameInput" class="form-control-custom mb-3" placeholder="Enter new name">
      
      <div class="flex gap-2">
        <button onclick="closeEditName()" class="btn-outline-custom flex-1">Cancel</button>
        <button id="saveNameBtn" class="btn-primary-custom flex-1">Save</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="../js/utils.js"></script>
  <script src="../js/storage-manager.js"></script>
  <script src="../js/avatar-manager.js"></script>

  <script>
    let currentUserId = null;
    let currentUser = null;

    // Initialize
    async function init() {
      try {
        currentUserId = Utils.getLocalStorage('currentUserId');
        if (!currentUserId) {
          window.location.href = '../index.html';
          return;
        }

        currentUser = await StorageManager.getUser(currentUserId);
        
        if (!currentUser) {
          window.location.href = '../index.html';
          return;
        }

        await loadProfile();
        await loadStatistics();
        await checkAchievements();

      } catch (error) {
        console.error('Initialization error:', error);
        Utils.showToast('Failed to load profile', 'error');
      }
    }

    // Load profile
    async function loadProfile() {
      document.getElementById('profileName').textContent = currentUser.name;
      
      if (currentUser.email) {
        document.getElementById('profileEmail').textContent = currentUser.email;
      }

      const memberDate = new Date(currentUser.createdAt);
      document.getElementById('memberSince').textContent = memberDate.toLocaleDateString();

      // Load avatar
      await AvatarManager.init(currentUserId);
      AvatarManager.renderToElement(document.getElementById('profileAvatar'), null, 100);
    }

    // Load statistics
    async function loadStatistics() {
      try {
        const history = await StorageManager.getTranslationHistory(currentUserId, 1000);
        
        // Total translations
        document.getElementById('totalTranslations').textContent = history.length;

        // Unique signs learned
        const uniqueSigns = new Set(history.map(t => t.output)).size;
        document.getElementById('signsLearned').textContent = uniqueSigns;

        // Days active
        const firstDay = history.length > 0 ? history[history.length - 1].timestamp : currentUser.createdAt;
        const daysDiff = Math.floor((Date.now() - firstDay) / (1000 * 60 * 60 * 24));
        document.getElementById('daysActive').textContent = Math.max(1, daysDiff);

        // Average per day
        const avgPerDay = (history.length / Math.max(1, daysDiff)).toFixed(1);
        document.getElementById('avgPerDay').textContent = avgPerDay;

      } catch (error) {
        console.error('Failed to load statistics:', error);
      }
    }

    // Check achievements
    async function checkAchievements() {
      try {
        const history = await StorageManager.getTranslationHistory(currentUserId, 1000);
        
        // First Steps (1+ translations)
        if (history.length >= 1) {
          document.getElementById('achievement1').classList.remove('locked');
        }

        // On Fire (10 translations in one day)
        const today = new Date().setHours(0, 0, 0, 0);
        const todayCount = history.filter(t => t.timestamp >= today).length;
        if (todayCount >= 10) {
          document.getElementById('achievement2').classList.remove('locked');
        }

        // Star Signer (50 different signs)
        const uniqueSigns = new Set(history.map(t => t.output)).size;
        if (uniqueSigns >= 50) {
          document.getElementById('achievement3').classList.remove('locked');
        }

        // Master (100 total translations)
        if (history.length >= 100) {
          document.getElementById('achievement4').classList.remove('locked');
        }

      } catch (error) {
        console.error('Failed to check achievements:', error);
      }
    }

    // Edit name
    document.getElementById('editNameBtn').addEventListener('click', () => {
      document.getElementById('newNameInput').value = currentUser.name;
      document.getElementById('editNameModal').style.display = 'block';
    });

    function closeEditName() {
      document.getElementById('editNameModal').style.display = 'none';
    }

    document.getElementById('saveNameBtn').addEventListener('click', async () => {
      const newName = document.getElementById('newNameInput').value.trim();
      
      if (!newName) {
        Utils.showToast('Please enter a name', 'warning');
        return;
      }

      try {
        await StorageManager.updateUser(currentUserId, { name: newName });
        currentUser.name = newName;
        document.getElementById('profileName').textContent = newName;
        closeEditName();
        Utils.showToast('Name updated', 'success');
      } catch (error) {
        console.error('Failed to update name:', error);
        Utils.showToast('Failed to update name', 'error');
      }
    });

    // Delete account
    document.getElementById('deleteAccountBtn').addEventListener('click', async () => {
      if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
        if (confirm('All your data including translations and settings will be permanently deleted. Continue?')) {
          try {
            await StorageManager.deleteUser(currentUserId);
            await StorageManager.deleteFaceEncoding(currentUserId);
            await StorageManager.clearTranslationHistory(currentUserId);
            Utils.removeLocalStorage('currentUserId');
            
            Utils.showToast('Account deleted', 'success');
            setTimeout(() => {
              window.location.href = '../index.html';
            }, 1500);
          } catch (error) {
            console.error('Failed to delete account:', error);
            Utils.showToast('Failed to delete account', 'error');
          }
        }
      }
    });

    // Close modal on background click
    document.getElementById('editNameModal').addEventListener('click', (e) => {
      if (e.target.id === 'editNameModal') {
        closeEditName();
      }
    });

    // Initialize on load
    window.addEventListener('DOMContentLoaded', init);
  </script>

  <style>
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9999;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
    }

    .stat-card {
      text-align: center;
      padding: 20px;
      background: var(--bg-light);
      border-radius: var(--border-radius-sm);
    }

    .dark-mode .stat-card {
      background: rgba(255, 255, 255, 0.05);
    }

    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 8px;
    }

    .stat-label {
      font-size: 14px;
      color: var(--text-muted-light);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .achievement-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
    }

    .achievement-card {
      text-align: center;
      padding: 24px;
      background: var(--bg-light);
      border-radius: var(--border-radius);
      border: 2px solid var(--success-color);
      transition: all 0.3s;
    }

    .achievement-card.locked {
      border-color: var(--border-light);
      opacity: 0.5;
    }

    .dark-mode .achievement-card {
      background: rgba(255, 255, 255, 0.05);
    }

    .achievement-icon {
      font-size: 48px;
      margin-bottom: 12px;
    }

    .achievement-name {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .achievement-desc {
      font-size: 12px;
      color: var(--text-muted-light);
    }

    .achievement-card:not(.locked):hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }
  </style>
</body>
</html>